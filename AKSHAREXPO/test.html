<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Page - AksharJobs Systems</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #5a67d8;
        }
        .result {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .success { border-color: #48bb78; background: #f0fff4; }
        .error { border-color: #f56565; background: #fff5f5; }
    </style>
</head>
<body>
    <h1>🧪 AksharJobs Systems Test Page</h1>
    
    <div class="test-section">
        <h2>🔗 Referral System Test</h2>
        <p>Test the referral clicks functionality that was showing "undefined" referrer.</p>
        <button class="test-button" onclick="testReferralClicks()">Test Referral Clicks</button>
        <button class="test-button" onclick="testReferralData()">Test Referral Data</button>
        <div id="referralResult" class="result" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <h2>📊 Live Visitor Tracking Test</h2>
        <p>Test the live visitor tracking system for the expo landing page.</p>
        <button class="test-button" onclick="testLiveTracking()">Test Live Tracking</button>
        <button class="test-button" onclick="testLiveCount()">Test Live Count</button>
        <div id="liveResult" class="result" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <h2>🎯 User Email Test</h2>
        <p>Test the getCurrentUserEmail function that was causing the undefined issue.</p>
        <button class="test-button" onclick="testUserEmail()">Test User Email</button>
        <button class="test-button" onclick="setTestUser()">Set Test User</button>
        <div id="emailResult" class="result" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <h2>🔄 Complete System Test</h2>
        <p>Run all tests to verify everything is working correctly.</p>
        <button class="test-button" onclick="runAllTests()" style="background: #10b981;">Run All Tests</button>
        <div id="allTestsResult" class="result" style="display: none;"></div>
    </div>
    
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbwjl75BoBiVOf2vEKXSioM7_ZhY1n5q5DluxxgGjx6uHK21b6KffVC94NGMqlaUN3XklQ/exec';
        
        function showResult(elementId, result, isSuccess = true) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `result ${isSuccess ? 'success' : 'error'}`;
            element.textContent = typeof result === 'object' ? JSON.stringify(result, null, 2) : result;
        }
        
        // Test referral clicks
        async function testReferralClicks() {
            try {
                const testEmail = 'test@example.com';
                const url = `${API_URL}?action=get_referral_clicks&referrer=${encodeURIComponent(testEmail)}`;
                
                const response = await fetch(url, { method: 'GET', mode: 'cors' });
                const data = await response.json();
                
                showResult('referralResult', {
                    test: 'Referral Clicks',
                    email: testEmail,
                    response: data,
                    status: response.status
                }, response.ok);
                
            } catch (error) {
                showResult('referralResult', {
                    test: 'Referral Clicks',
                    error: error.message,
                    status: 'Failed'
                }, false);
            }
        }
        
        // Test referral data
        async function testReferralData() {
            try {
                const testEmail = 'test@example.com';
                const url = `${API_URL}?action=get_referrals&email=${encodeURIComponent(testEmail)}`;
                
                const response = await fetch(url, { method: 'GET', mode: 'cors' });
                const data = await response.json();
                
                showResult('referralResult', {
                    test: 'Referral Data',
                    email: testEmail,
                    response: data,
                    status: response.status
                }, response.ok);
                
            } catch (error) {
                showResult('referralResult', {
                    test: 'Referral Data',
                    error: error.message,
                    status: 'Failed'
                }, false);
            }
        }
        
        // Test live tracking
        async function testLiveTracking() {
            try {
                const testData = {
                    type: 'visitor_tracking',
                    action: 'track_visit',
                    visitorId: 'test_visitor_' + Date.now(),
                    sessionId: 'test_session_' + Date.now(),
                    isNewVisitor: true,
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    language: navigator.language,
                    screenResolution: `${screen.width}x${screen.height}`,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    referrer: document.referrer || 'test-page',
                    url: window.location.href,
                    pageTitle: document.title
                };
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                
                const data = await response.json();
                
                showResult('liveResult', {
                    test: 'Live Visitor Tracking',
                    sentData: testData,
                    response: data,
                    status: response.status
                }, response.ok);
                
            } catch (error) {
                showResult('liveResult', {
                    test: 'Live Visitor Tracking',
                    error: error.message,
                    status: 'Failed'
                }, false);
            }
        }
        
        // Test live count
        async function testLiveCount() {
            try {
                const url = `${API_URL}?action=get_live_count`;
                
                const response = await fetch(url, { method: 'GET', mode: 'cors' });
                const data = await response.json();
                
                showResult('liveResult', {
                    test: 'Live Count',
                    response: data,
                    status: response.status
                }, response.ok);
                
            } catch (error) {
                showResult('liveResult', {
                    test: 'Live Count',
                    error: error.message,
                    status: 'Failed'
                }, false);
            }
        }
        
        // Test user email function
        function testUserEmail() {
            try {
                // Simulate the getCurrentUserEmail function
                function getCurrentUserEmail() {
                    const email = localStorage.getItem('currentUserEmail');
                    console.log('getCurrentUserEmail called, returning:', email);
                    return email || 'anonymous@example.com';
                }
                
                const currentEmail = getCurrentUserEmail();
                
                showResult('emailResult', {
                    test: 'User Email Function',
                    currentEmail: currentEmail,
                    localStorageValue: localStorage.getItem('currentUserEmail'),
                    isAnonymous: currentEmail === 'anonymous@example.com'
                }, true);
                
            } catch (error) {
                showResult('emailResult', {
                    test: 'User Email Function',
                    error: error.message
                }, false);
            }
        }
        
        // Set test user
        function setTestUser() {
            const testEmail = 'testuser@example.com';
            localStorage.setItem('currentUserEmail', testEmail);
            
            showResult('emailResult', {
                test: 'Set Test User',
                setEmail: testEmail,
                message: 'Test user email set successfully'
            }, true);
        }
        
        // Run all tests
        async function runAllTests() {
            const results = [];
            
            try {
                // Test 1: User Email
                const currentEmail = localStorage.getItem('currentUserEmail') || 'anonymous@example.com';
                results.push(`✅ User Email: ${currentEmail}`);
                
                // Test 2: Referral Clicks
                try {
                    const url1 = `${API_URL}?action=get_referral_clicks&referrer=${encodeURIComponent(currentEmail)}`;
                    const response1 = await fetch(url1, { method: 'GET', mode: 'cors' });
                    const data1 = await response1.json();
                    results.push(`✅ Referral Clicks: ${response1.ok ? 'Working' : 'Failed'}`);
                } catch (error) {
                    results.push(`❌ Referral Clicks: ${error.message}`);
                }
                
                // Test 3: Live Tracking
                try {
                    const url2 = `${API_URL}?action=get_live_count`;
                    const response2 = await fetch(url2, { method: 'GET', mode: 'cors' });
                    const data2 = await response2.json();
                    results.push(`✅ Live Tracking: ${response2.ok ? 'Working' : 'Failed'}`);
                } catch (error) {
                    results.push(`❌ Live Tracking: ${error.message}`);
                }
                
                // Test 4: API Connection
                try {
                    const response3 = await fetch(API_URL, { method: 'GET', mode: 'cors' });
                    results.push(`✅ API Connection: ${response3.ok ? 'Working' : 'Failed'}`);
                } catch (error) {
                    results.push(`❌ API Connection: ${error.message}`);
                }
                
                showResult('allTestsResult', {
                    timestamp: new Date().toISOString(),
                    tests: results,
                    summary: `${results.filter(r => r.includes('✅')).length}/${results.length} tests passed`
                }, true);
                
            } catch (error) {
                showResult('allTestsResult', {
                    error: error.message,
                    timestamp: new Date().toISOString()
                }, false);
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🧪 Test page loaded');
        });
    </script>
</body>
</html>
